<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼è²·è¨˜éŒ„ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #000000;
            color: white;
        }
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header {
            background: rgba(55, 65, 81, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        .header h1 {
            color: #ef4444;
            margin: 0 0 1rem 0;
        }
        .stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .stat-card {
            background: rgba(55, 65, 81, 0.5);
            border-radius: 8px;
            padding: 1rem;
            flex: 1;
            min-width: 150px;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ef4444;
        }
        .stat-label {
            color: #9ca3af;
            font-size: 0.9rem;
        }
        .filters {
            background: rgba(55, 65, 81, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        .filter-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .filter-group label {
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .filter-group select,
        .filter-group input {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            color: white;
            font-size: 0.9rem;
        }
        .btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .btn-secondary {
            background: transparent;
            color: #9ca3af;
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        .btn-secondary:hover {
            background: rgba(75, 85, 99, 0.3);
            color: white;
        }
        .purchases-table {
            background: rgba(55, 65, 81, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(75, 85, 99, 0.3);
            overflow-x: auto;
            min-width: 100%;
        }
        table {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(75, 85, 99, 0.3);
            white-space: nowrap;
        }
        /* ç‰¹å®šæ¬„ä½å¯¬åº¦è¨­å®š */
        th:nth-child(1), td:nth-child(1) { width: 140px; } /* è³¼è²·æ™‚é–“ */
        th:nth-child(2), td:nth-child(2) { width: 100px; } /* å§“å */
        th:nth-child(3), td:nth-child(3) { width: 180px; } /* é›»å­éƒµä»¶ */
        th:nth-child(4), td:nth-child(4) { width: 160px; } /* è¯çµ¡æ–¹å¼ */
        th:nth-child(5), td:nth-child(5) { width: 200px; white-space: normal; } /* ç¥¨åˆ¸ */
        th:nth-child(6), td:nth-child(6) { width: 60px; } /* æ•¸é‡ */
        th:nth-child(7), td:nth-child(7) { width: 100px; } /* åŸºæœ¬ç¥¨åƒ¹ */
        th:nth-child(8), td:nth-child(8) { width: 100px; } /* é¡å¤–é‡‘é¡ */
        th:nth-child(9), td:nth-child(9) { width: 100px; } /* ç¸½é¡ */
        th:nth-child(10), td:nth-child(10) { width: 100px; } /* æ”¯ä»˜æ–¹å¼ */
        th:nth-child(11), td:nth-child(11) { width: 100px; } /* ç‹€æ…‹ */
        th:nth-child(12), td:nth-child(12) { width: 200px; } /* æ“ä½œ */
        th {
            background: rgba(55, 65, 81, 0.5);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        td {
            color: #d1d5db;
            font-size: 0.9rem;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        .status-confirmed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .status-completed {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« è³¼è²·è¨˜éŒ„ç®¡ç†</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-purchases">-</div>
                    <div class="stat-label">ç¸½è³¼è²·è¨˜éŒ„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-purchases">-</div>
                    <div class="stat-label">å¾…ç¢ºèª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="confirmed-purchases">-</div>
                    <div class="stat-label">å·²ç¢ºèª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">-</div>
                    <div class="stat-label">ç¸½æ”¶å…¥</div>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>ç‹€æ…‹ç¯©é¸</label>
                    <select id="status-filter">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending">å¾…ç¢ºèª</option>
                        <option value="confirmed">å·²ç¢ºèª</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æ´»å‹•ç¯©é¸</label>
                    <select id="event-filter">
                        <option value="">å…¨éƒ¨æ´»å‹•</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>è¯çµ¡æ–¹å¼</label>
                    <select id="contact-filter">
                        <option value="">å…¨éƒ¨æ–¹å¼</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="email">é›»å­éƒµä»¶</option>
                        <option value="phone">é›»è©±</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æœå°‹</label>
                    <input type="text" id="search-input" placeholder="æœå°‹å§“åæˆ–é›»å­éƒµä»¶">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="loadPurchases()">ç¯©é¸</button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤</button>
                </div>
            </div>
        </div>

        <div class="purchases-table">
            <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>
            
            <table id="purchases-table" style="display: none;">
                <thead>
                    <tr>
                        <th>è³¼è²·æ™‚é–“</th>
                        <th>å§“å</th>
                        <th>é›»å­éƒµä»¶</th>
                        <th>è¯çµ¡æ–¹å¼</th>
                        <th>ç¥¨åˆ¸</th>
                        <th>æ•¸é‡</th>
                        <th>åŸºæœ¬ç¥¨åƒ¹</th>
                        <th>é¡å¤–é‡‘é¡</th>
                        <th>ç¸½é¡</th>
                        <th>æ”¯ä»˜æ–¹å¼</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="purchases-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5001/api' 
            : '/api';
        let allPurchases = [];
        let allEvents = [];

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadEvents();
            await loadPurchases();
        });

        // è¼‰å…¥æ´»å‹•åˆ—è¡¨
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/events`);
                const data = await response.json();
                
                if (data.success) {
                    allEvents = data.data;
                    const eventFilter = document.getElementById('event-filter');
                    eventFilter.innerHTML = '<option value="">å…¨éƒ¨æ´»å‹•</option>';
                    
                    allEvents.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event._id;
                        option.textContent = event.title;
                        eventFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥æ´»å‹•åˆ—è¡¨å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥è³¼è²·è¨˜éŒ„
        async function loadPurchases() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const table = document.getElementById('purchases-table');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            table.style.display = 'none';

            try {
                const params = new URLSearchParams();
                
                const statusFilter = document.getElementById('status-filter').value;
                const eventFilter = document.getElementById('event-filter').value;
                const contactFilter = document.getElementById('contact-filter').value;
                const searchInput = document.getElementById('search-input').value;
                
                if (statusFilter) params.append('status', statusFilter);
                if (eventFilter) params.append('eventId', eventFilter);
                if (contactFilter) params.append('contactMethod', contactFilter);
                if (searchInput) params.append('email', searchInput);

                const response = await fetch(`${API_BASE}/purchases?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    allPurchases = data.data;
                    displayPurchases(allPurchases);
                    updateStats(allPurchases);
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                } else {
                    throw new Error(data.message || 'è¼‰å…¥è³¼è²·è¨˜éŒ„å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥è³¼è²·è¨˜éŒ„å¤±æ•—:', error);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }

        // é¡¯ç¤ºè³¼è²·è¨˜éŒ„
        function displayPurchases(purchases) {
            const tbody = document.getElementById('purchases-tbody');
            tbody.innerHTML = '';

            purchases.forEach(purchase => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(purchase.createdAt).toLocaleString('zh-TW')}</td>
                    <td>${purchase.username}</td>
                    <td>${purchase.email}</td>
                    <td>${getContactMethodText(purchase.contactMethod, purchase.contactInfo)}</td>
                    <td>${purchase.ticket ? purchase.ticket.name : 'N/A'}</td>
                    <td>${purchase.quantity}</td>
                    <td>HK$${purchase.ticket ? purchase.ticket.price : 0}</td>
                    <td>HK$${purchase.additionalAmount || 0}</td>
                    <td>HK$${purchase.totalPrice || purchase.totalAmount || 0}</td>
                    <td>
                        ${purchase.paymentMethod === 'stripe' ? 
                            '<span style="color: #10b981; font-weight: 600;">Stripe</span>' : 
                            '<span style="color: #6b7280;">æ‰‹å‹•</span>'
                        }
                    </td>
                    <td><span class="status-badge status-${purchase.status}">${getStatusText(purchase.status)}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${purchase.status === 'pending' ? `
                                <button class="btn btn-small" onclick="updateStatus('${purchase._id}', 'confirmed')">ç¢ºèª</button>
                                <button class="btn btn-small btn-secondary" onclick="updateStatus('${purchase._id}', 'cancelled')">å–æ¶ˆ</button>
                            ` : ''}
                            ${purchase.paymentMethod === 'stripe' && purchase.stripePaymentLinkUrl ? `
                                <button class="btn btn-small btn-secondary" onclick="window.open('${purchase.stripePaymentLinkUrl}', '_blank')">æ”¯ä»˜é€£çµ</button>
                            ` : ''}
                            <button class="btn btn-small btn-secondary" onclick="viewDetails('${purchase._id}')">è©³æƒ…</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats(purchases) {
            const total = purchases.length;
            const pending = purchases.filter(p => p.status === 'pending').length;
            const confirmed = purchases.filter(p => p.status === 'confirmed').length;
            const totalRevenue = purchases
                .filter(p => p.status === 'confirmed' || p.status === 'completed')
                .reduce((sum, p) => sum + (p.totalPrice || p.totalAmount || 0), 0);

            document.getElementById('total-purchases').textContent = total;
            document.getElementById('pending-purchases').textContent = pending;
            document.getElementById('confirmed-purchases').textContent = confirmed;
            document.getElementById('total-revenue').textContent = `HK$${totalRevenue}`;
        }

        // æ›´æ–°è³¼è²·ç‹€æ…‹
        async function updateStatus(purchaseId, status) {
            try {
                const response = await fetch(`${API_BASE}/purchases/${purchaseId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`è³¼è²·è¨˜éŒ„ç‹€æ…‹å·²æ›´æ–°ç‚º: ${getStatusText(status)}`);
                    await loadPurchases();
                } else {
                    throw new Error(data.message || 'æ›´æ–°ç‹€æ…‹å¤±æ•—');
                }
            } catch (error) {
                console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
                showError(`æ›´æ–°ç‹€æ…‹å¤±æ•—: ${error.message}`);
            }
        }

        // æŸ¥çœ‹è©³æƒ…
        function viewDetails(purchaseId) {
            const purchase = allPurchases.find(p => p._id === purchaseId);
            if (purchase) {
                const details = `
è³¼è²·è¨˜éŒ„è©³æƒ…:
- å§“å: ${purchase.username}
- é›»å­éƒµä»¶: ${purchase.email}
- è¯çµ¡æ–¹å¼: ${getContactMethodText(purchase.contactMethod, purchase.contactInfo)}
- ç¥¨åˆ¸: ${purchase.ticket ? purchase.ticket.name : 'N/A'}
- æ•¸é‡: ${purchase.quantity}
- åŸºæœ¬ç¥¨åƒ¹: HK$${purchase.ticket ? purchase.ticket.price : 0}
- é¡å¤–é‡‘é¡: HK$${purchase.additionalAmount || 0}
- ç¸½é‡‘é¡: HK$${purchase.totalPrice || purchase.totalAmount || 0}
- ç‹€æ…‹: ${getStatusText(purchase.status)}
- è³¼è²·æ™‚é–“: ${new Date(purchase.createdAt).toLocaleString('zh-TW')}
- å‚™è¨»: ${purchase.notes || 'ç„¡'}
                `;
                alert(details);
            }
        }

        // æ¸…é™¤ç¯©é¸å™¨
        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('event-filter').value = '';
            document.getElementById('contact-filter').value = '';
            document.getElementById('search-input').value = '';
            loadPurchases();
        }

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccess(message) {
            const success = document.getElementById('success');
            success.style.display = 'block';
            success.textContent = message;
            setTimeout(() => {
                success.style.display = 'none';
            }, 3000);
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const error = document.getElementById('error');
            error.style.display = 'block';
            error.textContent = message;
            setTimeout(() => {
                error.style.display = 'none';
            }, 5000);
        }

        // è¼”åŠ©å‡½æ•¸
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…ç¢ºèª',
                'confirmed': 'å·²ç¢ºèª',
                'cancelled': 'å·²å–æ¶ˆ',
                'completed': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        function getContactMethodText(method, contactInfo) {
            const methodMap = {
                'whatsapp': 'WhatsApp',
                'email': 'é›»å­éƒµä»¶',
                'phone': 'é›»è©±'
            };
            const methodText = methodMap[method] || method;
            
            // å¦‚æœæœ‰è¯çµ¡è³‡è¨Šï¼Œé¡¯ç¤ºè¯çµ¡æ–¹å¼ + è¯çµ¡è³‡è¨Š
            if (contactInfo) {
                return `${methodText}: ${contactInfo}`;
            }
            
            return methodText;
        }
    </script>
</body>
</html>







