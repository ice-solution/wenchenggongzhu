<VirtualHost *:80>
    ServerName wenchenggongzhu.brandactivation.hk
    ServerAlias wenchenggongzhu.brandactivation.hk
    ServerAdmin webmaster@brandactivation.hk

    # 文檔根目錄 (前端構建文件)
    DocumentRoot /var/www/html/wenchenggongzhu/client/build

    # 日誌文件
    ErrorLog ${APACHE_LOG_DIR}/wenchenggongzhu_error.log
    CustomLog ${APACHE_LOG_DIR}/wenchenggongzhu_access.log combined

    # API 路徑代理到後端 (必須在前端路由之前)
    ProxyPreserveHost On
    ProxyPass /api http://localhost:5001/api
    ProxyPassReverse /api http://localhost:5001/api

    # 管理後台頁面代理到後端
    ProxyPass /purchase-manager http://localhost:5001/purchase-manager
    ProxyPassReverse /purchase-manager http://localhost:5001/purchase-manager

    # 前端路由支持 (SPA)
    <Directory /var/www/html/wenchenggongzhu/client/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # 處理前端路由
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api
        RewriteCond %{REQUEST_URI} !^/purchase-manager
        RewriteRule . /index.html [L]
    </Directory>

    # 靜態資源快取
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>

    # Gzip 壓縮
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # 安全標頭
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # 支持 Cloudflare 的真實 IP
    # 獲取訪客真實 IP（通過 Cloudflare CF-Connecting-IP）
    <IfModule mod_remoteip.c>
        RemoteIPHeader CF-Connecting-IP
        RemoteIPTrustedProxy 173.245.48.0/20
        RemoteIPTrustedProxy 103.21.244.0/22
        RemoteIPTrustedProxy 103.22.200.0/22
        RemoteIPTrustedProxy 103.31.4.0/22
        RemoteIPTrustedProxy 141.101.64.0/18
        RemoteIPTrustedProxy 108.162.192.0/18
        RemoteIPTrustedProxy 190.93.240.0/20
        RemoteIPTrustedProxy 188.114.96.0/20
        RemoteIPTrustedProxy 197.234.240.0/22
        RemoteIPTrustedProxy 198.41.128.0/17
        RemoteIPTrustedProxy 162.158.0.0/15
        RemoteIPTrustedProxy 104.16.0.0/13
        RemoteIPTrustedProxy 104.24.0.0/14
        RemoteIPTrustedProxy 172.64.0.0/13
        RemoteIPTrustedProxy 131.0.72.0/22
    </IfModule>

    # 文成公主國際基金會特定的安全設定
    # 防止訪問敏感文件
    <FilesMatch "\.(env|log|conf)$">
        Require all denied
    </FilesMatch>

    # 設定適當的 MIME 類型
    AddType application/javascript .js
    AddType text/css .css
    AddType image/svg+xml .svg
</VirtualHost>

# HTTP 到 HTTPS 重定向 (Cloudflare Flexible SSL)
<VirtualHost *:80>
    ServerName wenchenggongzhu.brandactivation.hk
    ServerAlias wenchenggongzhu.brandactivation.hk
    
    RewriteEngine On
    RewriteCond %{HTTP:CF-Visitor} '"scheme":"http"'
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
